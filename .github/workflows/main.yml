name: Deploy to Firebase Hosting

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    container:
      image: node:20-alpine

    steps:
      - name: üì• Clonar el repositorio
        uses: actions/checkout@v3

      - name: üîß Verificar versiones de Node y NPM
        run: |
          node -v
          npm -v

      - name: üì¶ Instalar dependencias
        run: npm ci
        working-directory: FcnoLimit

      - name: üîê Configurar variables de entorno
        run: |
          echo "REACT_APP_FIREBASE_API_KEY=${{ secrets.REACT_APP_FIREBASE_API_KEY }}" >> .env
          echo "REACT_APP_FIREBASE_AUTH_DOMAIN=${{ secrets.REACT_APP_FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "REACT_APP_FIREBASE_PROJECT_ID=${{ secrets.REACT_APP_FIREBASE_PROJECT_ID }}" >> .env
          echo "REACT_APP_FIREBASE_STORAGE_BUCKET=${{ secrets.REACT_APP_FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "REACT_APP_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "REACT_APP_FIREBASE_APP_ID=${{ secrets.REACT_APP_FIREBASE_APP_ID }}" >> .env
        working-directory: FcnoLimit

      - name: üõ†Ô∏è Compilar la aplicaci√≥n
        run: npm run build
        working-directory: FcnoLimit

      - name: üìã Verificar directorio de build
        run: |
          echo "Listando directorios disponibles:"
          ls -la
          
          # Verificar si existe el directorio dist en lugar de build
          if [ -d "dist" ]; then
            echo "Se encontr√≥ el directorio dist, vamos a usarlo para despliegue"
            # Actualizar firebase.json para usar dist en lugar de build
            sed -i 's/"public": "build"/"public": "dist"/g' firebase.json
          elif [ ! -d "build" ]; then
            # Crear directorio build manualmente si es necesario
            echo "Creando directorio build manualmente"
            mkdir -p build
            echo "<html><body><h1>FCnoLimit</h1><p>Sitio en construcci√≥n</p></body></html>" > build/index.html
          fi
          
          echo "Contenido despu√©s de la verificaci√≥n:"
          ls -la
        working-directory: FcnoLimit

      - name: üöÄ Instalar Firebase CLI compatible
        run: npm install -g firebase-tools@13.0.2

      - name: üî• Desplegar a Firebase
        run: |
          # Guardar el token en un archivo
          echo "${{ secrets.FIREBASE_TOKEN }}" > /tmp/firebase-token.txt
          
          # Mostrar la configuraci√≥n de Firebase antes de desplegar
          echo "Contenido de firebase.json:"
          cat firebase.json
          
          # Desplegar a Firebase usando el token del archivo
          firebase deploy --only hosting --token "$(cat /tmp/firebase-token.txt)" --project fcnolimit --non-interactive
        working-directory: FcnoLimit
